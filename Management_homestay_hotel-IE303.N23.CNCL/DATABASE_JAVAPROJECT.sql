CREATE DATABASE MANAGEMENTHOMESTAYHOTEL;
USE MANAGEMENTHOMESTAYHOTEL;

CREATE TABLE HOTELHOMESTAY (
	HTHSID INT PRIMARY KEY AUTO_INCREMENT,
    HTHSNAME VARCHAR(30),
    HTHSADDRESS VARCHAR(50),
    ROOMCOUNT INT
);

CREATE TABLE ROOM (
	ROOMID INT PRIMARY KEY AUTO_INCREMENT,
    ROOMNAME VARCHAR(20),
    ROOMTYPE VARCHAR(40),
    ROOMRATES DOUBLE,
    ROOMSTATUS BOOLEAN,
    HTHSID INT,
    FOREIGN KEY (HTHSID) REFERENCES HOTELHOMESTAY(HTHSID)
);

CREATE TABLE CUSTOMER (
	CUSTOMERID INT PRIMARY KEY AUTO_INCREMENT,
    CUSTOMERNAME VARCHAR(20),
    PHONE BIGINT,
    ADDRESS VARCHAR(50)
);

CREATE TABLE BOOKING (
	BOOKINGID INT PRIMARY KEY AUTO_INCREMENT,
    CUSTOMERID INT,
    ROOMID INT,
    BOOKINGDATE DATETIME,
    CHECKINDATE DATE,
    CHECKOUTDATE DATE,
    FOREIGN KEY (CUSTOMERID) REFERENCES CUSTOMER(CUSTOMERID),
    FOREIGN KEY (ROOMID) REFERENCES ROOM(ROOMID)
);

CREATE TABLE EMPLOYEE (
	EMPID INT PRIMARY KEY AUTO_INCREMENT,
    EMPNAME VARCHAR(20),
    SHIFT INT,
	EMPPHONE BIGINT,
    EMPADDRESS VARCHAR(50),
    EMPACCOUNT VARCHAR(30),
    EMPPASSWORD VARCHAR(10)
);

CREATE TABLE BILL (
	BILLID INT PRIMARY KEY AUTO_INCREMENT,
	CREATEDATE DATETIME,
	CUSTOMERID INT,
    EMPID INT,
    TOTALAMOUNT DOUBLE,
	PAID BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (CUSTOMERID) REFERENCES CUSTOMER(CUSTOMERID),
    FOREIGN KEY (EMPID) REFERENCES EMPLOYEE(EMPID)
);

CREATE TABLE SERVICE (
	SERVICEID INT PRIMARY KEY AUTO_INCREMENT,
	SERVICENAME VARCHAR(20),
	PRICE DOUBLE	
);

CREATE TABLE BILLDETAILS (
	BILLDETAILSID INT PRIMARY KEY AUTO_INCREMENT,
	BILLID INT,
	SERVICEID INT,
    FOREIGN KEY (BILLID) REFERENCES BILL(BILLID),
    FOREIGN KEY (SERVICEID) REFERENCES SERVICE(SERVICEID)
);



ALTER TABLE BOOKING
ADD CONSTRAINT DATE_CHECK CHECK (CHECKINDATE<=CHECKOUTDATE);

DELIMITER //

CREATE TRIGGER before_booking_insert
BEFORE INSERT ON BOOKING
FOR EACH ROW
BEGIN
    DECLARE room_status BOOL;

    SELECT ROOMSTATUS INTO room_status
    FROM ROOM
    WHERE ROOMID = NEW.ROOMID;

    IF room_status = true THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot book a room with status true';
    END IF;
END //

DELIMITER ;

INSERT INTO HOTELHOMESTAY (HTHSID, HTHSNAME, HTHSADDRESS, ROOMCOUNT)
VALUES 
(111, 'Graden Hotel', 'Quan 1, TP Ho Chi Minh', 10),
(222, 'Graden HomeStay', 'TP Da Lat', 2);

INSERT INTO ROOM (ROOMID, ROOMNAME, ROOMTYPE, ROOMRATES, ROOMSTATUS, HTHSID)
VALUES 
(01, 'P01', 'Single bed room', 100000, false, 111),
(02, 'P02', 'Single bed room', 100000, true, 111),
(03, 'P03', 'Twin bed room', 250000, false, 111),
(04, 'P04', 'Twin bed room ', 250000, true, 111),
(05, 'P05', 'Double bed room', 250000, false, 111),
(06, 'P06', 'Double bed room', 250000, true, 111),
(07, 'P07', 'Double bed room', 250000, true, 111),
(08, 'P08', 'Triple bed room', 300000, false, 111),
(09, 'P09', 'Triple bed room', 300000, false, 111),
(10, 'P10', 'Triple bed room', 300000, false, 111),
(21, 'A0', 'Common room', 300000, false, 222),
(22, 'A1', 'Master room', 380000, false, 222);

INSERT INTO CUSTOMER (CUSTOMERID, CUSTOMERNAME, PHONE, ADDRESS)
VALUES 
(120101, 'Pham Van A', 0339857456, 'TP Nha Trang'),
(120102, 'Pham Thi B', 0339145368, 'TP Ninh Binh'),
(120103, 'Nguyen Van C', 0339471045, 'TP Long An'),
(120104, 'Tran Van D', 0371257456, 'TP Ho Chi Minh'),
(120105, 'Pham Nhat E', 0814257456, 'TP Quang Ngai');

INSERT INTO BOOKING (BOOKINGID, CUSTOMERID, ROOMID, BOOKINGDATE, CHECKINDATE, CHECKOUTDATE)
VALUES 
(1001, 120101, 03, '2023-02-12 10:30:00', '2023-02-14', '2023-02-16'),
(1002, 120102, 05, '2023-02-12 10:30:00', '2023-02-14', '2023-02-16'),
(1003, 120103, 08, '2023-02-12 10:30:00', '2023-02-14', '2023-02-16'),
(1004, 120104, 09, '2023-02-12 10:30:00', '2023-02-14', '2023-02-16'),
(1005, 120105, 10, '2023-02-12 10:30:00', '2023-02-14', '2023-02-16');

INSERT INTO EMPLOYEE (EMPID, EMPNAME, SHIFT, EMPPHONE, EMPADDRESS, EMPACCOUNT, EMPPASSWORD)
VALUES 
(10101, 'Tran Minh A', 1, 0815635541, 'Ktx khu A, TP Thu Duc', 'nhanvienca1', '123456789@Ca1'),
(10102, 'Lam Thanh B', 2, 0337420103, 'Ktx khu B, TP Thu Duc', 'nhanvienca2', '123456789@Ca2');
